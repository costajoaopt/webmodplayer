Module.onRuntimeInitialized=()=>{const THEME={sky1:"#e8eef7",sky2:"#d6deeb",blue1:"#3a64c9",blue2:"#0f245d",ink:"#2d3e55",sep:"#3a4a63",glow:"rgba(60,190,240,1)",grid:"rgba(30,40,60,0.35)",specBgTop:"#7a90a8",specBgBot:"#2e4a66",barTop:"#b3e5f9",barBot:"#1d6d96",peak:"#d0eaff",note:"#0d2c73",inst:"#1c6e1c",vol:"#a31212",fx:"#531875",};const fmtTime=(s)=>{if(!Number.isFinite(s))return "0:00";s=Math.max(0,Math.floor(s));return((s/60)| 0)+":"+(s % 60).toString().padStart(2,"0");};function getMeta(mod,key){const keyLen=lengthBytesUTF8(key)+1;const keyPtr=Module._malloc(keyLen);stringToUTF8(key,keyPtr,keyLen);const valPtr=Module._openmpt_module_get_metadata(mod,keyPtr);Module._free(keyPtr);if(!valPtr)return "";const str=UTF8ToString(valPtr);Module._openmpt_free_string(valPtr);return str;}function showSubsongButtons(show){const prev=document.getElementById("btnPrevSubsong");const next=document.getElementById("btnNextSubsong");if(show){prev.classList.remove("hidden");next.classList.remove("hidden");}else{prev.classList.add("hidden");next.classList.add("hidden");}}const file=document.getElementById("file");const controls=document.getElementById("controls");const btnPlay=document.getElementById("btnPlay");const btnPause=document.getElementById("btnPause");const btnStop=document.getElementById("btnStop");const btnPrevSubsong=document.getElementById("btnPrevSubsong");const btnNextSubsong=document.getElementById("btnNextSubsong");const seek=document.getElementById("seek");const curEl=document.getElementById("cur");const durEl=document.getElementById("dur");const metaBox=document.getElementById("meta");const volEl=document.getElementById("vol");const specCanvas=document.getElementById("spectrum");const specCtx=specCanvas.getContext("2d");const patCanvas=document.getElementById("patternCanvas");const patCtx=patCanvas.getContext("2d");const barSizeEl=document.getElementById("barSize");const gravityEl=document.getElementById("gravity");const glowEl=document.getElementById("glow");const specControls=document.getElementById("specControls");const amigaFilter=document.getElementById("amigaFilter");const ROW_HEIGHT=18;const PER_CH_WIDTH=120;const ROW_INDEX_W=40;const PADDING_X=6;let audioCtx=null,gainNode=null,analyser=null,scriptNode=null;let current=null,playing=false,totalSubsongs=1;function ensureAudioGraph(){if(!audioCtx)audioCtx=new(window.AudioContext || window.webkitAudioContext)();if(!gainNode)gainNode=audioCtx.createGain();if(!analyser){analyser=audioCtx.createAnalyser();analyser.fftSize=1024;analyser.smoothingTimeConstant=0.75;}if(!scriptNode){scriptNode=audioCtx.createScriptProcessor(4096,0,2);scriptNode.onaudioprocess=(e)=>{const L=e.outputBuffer.getChannelData(0),R=e.outputBuffer.getChannelData(1);if(!current || !playing){L.fill(0);R.fill(0);return;}const frames=e.outputBuffer.length;const s=current.readStereo(audioCtx.sampleRate,frames);for(let i=0,j=0;i<frames;i++,j+=2){L[i]=s[j] || 0;R[i]=s[j+1] || 0;}};scriptNode.connect(gainNode);}gainNode.connect(analyser);analyser.connect(audioCtx.destination);gainNode.gain.value=parseFloat(volEl.value);}class OpenMPTModule{constructor(u8){this.buf=Module._malloc(u8.length);HEAPU8.set(u8,this.buf);this.mod=Module._openmpt_module_create_from_memory(this.buf,u8.length,0,0,0);if(!this.mod)throw new Error("Could not create module");}destroy(){if(this.mod)Module._openmpt_module_destroy(this.mod);if(this.buf)Module._free(this.buf);this.mod=0;this.buf=0;}duration(){return Module._openmpt_module_get_duration_seconds(this.mod);}getPos(){return Module._openmpt_module_get_position_seconds(this.mod);}setPos(s){Module._openmpt_module_set_position_seconds(this.mod,s);}numChannels(){return Module._openmpt_module_get_num_channels(this.mod);}readStereo(sampleRate,frames){const bytes=frames*2*4;const ptr=Module._malloc(bytes);const got=Module._openmpt_module_read_interleaved_float_stereo(this.mod,sampleRate,frames,ptr);const out=new Float32Array(HEAPF32.buffer,ptr,got*2).slice();Module._free(ptr);return out;}cellText(pattern,row,channel){const strPtr=Module._openmpt_module_format_pattern_row_channel(this.mod,pattern,row,channel,0,0);if(!strPtr)return "";const s=UTF8ToString(strPtr);Module._openmpt_free_string(strPtr);return s;}numSubsongs(){return Module._openmpt_module_get_num_subsongs(this.mod);}getSubsong(){return Module._openmpt_module_get_selected_subsong(this.mod);}setSubsong(i){Module._openmpt_module_select_subsong(this.mod,i);}}function setAmiga(enabled){if(!current)return;Module._openmpt_module_set_render_param(current.mod,3,enabled ? 0:1,0.0);}function fitCanvasToCSSSize(canvas,ctx,desiredHeightPx){const rect=canvas.getBoundingClientRect();const cssWidth=Math.max(10,rect.width || canvas.clientWidth || canvas.width);const cssHeight=desiredHeightPx || rect.height || canvas.clientHeight || canvas.height;const dpr=window.devicePixelRatio || 1;canvas.width=Math.round(cssWidth*dpr);canvas.height=Math.round(cssHeight*dpr);canvas.style.width=cssWidth+"px";canvas.style.height=cssHeight+"px";ctx.setTransform(dpr,0,0,dpr,0,0);return{w:cssWidth,h:cssHeight,dpr};}let peaks=[],peakVel=[];let barGroupSize=8,gravity=0.2,glowBlur=7;function drawSpecBackground(w,h){const bgGrad=specCtx.createLinearGradient(0,0,0,h);bgGrad.addColorStop(0,THEME.specBgTop);bgGrad.addColorStop(1,THEME.specBgBot);specCtx.fillStyle=bgGrad;specCtx.fillRect(0,0,w,h);specCtx.strokeStyle=THEME.grid;specCtx.lineWidth=1;specCtx.beginPath();for(let y=0;y<=h;y+=10){specCtx.moveTo(0,y+0.5);specCtx.lineTo(w,y+0.5);}for(let x=0;x<=w;x+=10){specCtx.moveTo(x+0.5,0);specCtx.lineTo(x+0.5,h);}specCtx.stroke();const glossGrad=specCtx.createLinearGradient(0,0,0,h*0.45);glossGrad.addColorStop(0,"rgba(255,255,255,0.55)");glossGrad.addColorStop(1,"rgba(255,255,255,0)");specCtx.fillStyle=glossGrad;specCtx.fillRect(0,0,w,h*0.45);}function renderSpectrum(){const{w,h}=fitCanvasToCSSSize(specCanvas,specCtx,80);if(!analyser){drawSpecBackground(w,h);return;}drawSpecBackground(w,h);const data=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(data);const numBars=Math.max(1,Math.floor(data.length/barGroupSize));const barWidth=w/numBars;if(peaks.length !==numBars){peaks=new Array(numBars).fill(0);peakVel=new Array(numBars).fill(0);}const barGrad=specCtx.createLinearGradient(0,0,0,h);barGrad.addColorStop(0,THEME.barTop);barGrad.addColorStop(1,THEME.barBot);for(let i=0;i<numBars;i++){let sum=0;for(let j=0;j<barGroupSize;j++)sum+=data[i*barGroupSize+j] || 0;const v=sum/(barGroupSize*255);const bh=v*h;if(glowBlur>0){specCtx.save();specCtx.shadowBlur=glowBlur;specCtx.shadowColor=THEME.glow;specCtx.fillStyle=barGrad;specCtx.fillRect(i*barWidth+1,h-bh,barWidth-2,bh);specCtx.restore();}specCtx.fillStyle=barGrad;specCtx.fillRect(i*barWidth+1,h-bh,barWidth-2,bh);if(bh>peaks[i]){peaks[i]=bh;peakVel[i]=0;}else{peakVel[i]+=gravity;peaks[i]-=peakVel[i];if(peaks[i]<0){peaks[i]=0;peakVel[i]=0;}}const capY=h-peaks[i];const capH=Math.max(2,Math.min(4,barWidth*0.2));specCtx.fillStyle=THEME.peak;specCtx.fillRect(i*barWidth+1,capY-capH,barWidth-2,capH);specCtx.fillStyle="rgba(255,255,255,0.45)";specCtx.fillRect(i*barWidth+1,capY-capH,barWidth-2,capH*0.5);}}function colorParts(raw){const s=(raw || "... .. ... ...").padEnd(14," ");return{note:s.slice(0,3),inst:s.slice(4,6),vol:s.slice(7,10),fx:s.slice(11,14),};}function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}function renderPattern(){if(!current)return;const order=Module._openmpt_module_get_current_order(current.mod);const pat=Module._openmpt_module_get_order_pattern(current.mod,order);const curRow=Module._openmpt_module_get_current_row(current.mod);const rows=Module._openmpt_module_get_pattern_num_rows(current.mod,pat);const chs=current.numChannels();const headerHeight=Math.floor(ROW_HEIGHT*1.5);const cssW=ROW_INDEX_W+PADDING_X+chs*PER_CH_WIDTH;const baseH=512;const visibleRows=Math.floor((baseH-headerHeight)/ROW_HEIGHT);const cssH=headerHeight+visibleRows*ROW_HEIGHT;const dpr=window.devicePixelRatio || 1;patCanvas.width=Math.round(cssW*dpr);patCanvas.height=Math.round(cssH*dpr);patCanvas.style.width=cssW+"px";patCanvas.style.height=cssH+"px";patCtx.setTransform(dpr,0,0,dpr,0,0);const bgGrad=patCtx.createLinearGradient(0,0,0,cssH);bgGrad.addColorStop(0,THEME.sky1);bgGrad.addColorStop(1,THEME.sky2);patCtx.fillStyle=bgGrad;patCtx.fillRect(0,0,cssW,cssH);const headGrad=patCtx.createLinearGradient(0,0,0,headerHeight);headGrad.addColorStop(0,THEME.blue1);headGrad.addColorStop(1,THEME.blue2);patCtx.fillStyle=headGrad;patCtx.fillRect(0,0,cssW,headerHeight);const gloss=patCtx.createLinearGradient(0,0,0,headerHeight*0.7);gloss.addColorStop(0,"rgba(255,255,255,0.55)");gloss.addColorStop(1,"rgba(255,255,255,0)");patCtx.fillStyle=gloss;patCtx.fillRect(0,0,cssW,headerHeight*0.7);patCtx.font="12px monospace";patCtx.textBaseline="middle";patCtx.textAlign="left";patCtx.fillStyle="#fff";patCtx.fillText("ROW",PADDING_X,headerHeight/2);patCtx.textAlign="center";for(let c=0;c<chs;c++){const colCenter=ROW_INDEX_W+c*PER_CH_WIDTH+PER_CH_WIDTH/2;patCtx.fillText("CHANNEL "+(c+1).toString().padStart(2,"0"),colCenter,headerHeight/2);}patCtx.textAlign="left";patCtx.strokeStyle=THEME.sep;patCtx.beginPath();patCtx.moveTo(0,headerHeight+0.5);patCtx.lineTo(cssW,headerHeight+0.5);patCtx.stroke();patCtx.strokeStyle="#8393ad";patCtx.beginPath();for(let c=0;c<chs;c++){const x=ROW_INDEX_W+PADDING_X+c*PER_CH_WIDTH-6+0.5;patCtx.moveTo(x,headerHeight);patCtx.lineTo(x,cssH);}patCtx.stroke();const half=Math.floor(visibleRows/2);const centerY=headerHeight+half*ROW_HEIGHT+ROW_HEIGHT/2;patCtx.textBaseline="middle";for(let offset=-half;offset<=half;offset++){const rowIndex=curRow+offset;const isCurrent=rowIndex===curRow;const y=centerY+offset*ROW_HEIGHT;const yMid=y;if(rowIndex>=0 && rowIndex<rows){const rowHeight=isCurrent ? ROW_HEIGHT+2:ROW_HEIGHT;if(isCurrent){patCtx.save();patCtx.shadowColor="rgba(0,0,0,0.5)";patCtx.shadowBlur=5;patCtx.shadowOffsetY=2;patCtx.fillStyle="#fff";roundRect(patCtx,0.5,y-ROW_HEIGHT/2+0.5,cssW-1,rowHeight-1,3);patCtx.fill();patCtx.restore();patCtx.strokeStyle=THEME.sep;patCtx.lineWidth=1;roundRect(patCtx,0.5,y-ROW_HEIGHT/2+0.5,cssW-1,rowHeight-1,3);patCtx.stroke();}else if(rowIndex % 4===0){patCtx.fillStyle="rgba(0,0,0,0.08)";patCtx.fillRect(0,y-ROW_HEIGHT/2,cssW,rowHeight);}const fontSize=isCurrent ? 14:12;const fontWeight=isCurrent ? "bold ":"";patCtx.font=fontWeight+fontSize+"px monospace";patCtx.shadowColor="transparent";patCtx.shadowBlur=0;patCtx.fillStyle=isCurrent ? "#0d2c73":"#000";patCtx.fillText(rowIndex.toString().padStart(3,"0"),PADDING_X,yMid);for(let c=0;c<chs;c++){const xBase=ROW_INDEX_W+PADDING_X+c*PER_CH_WIDTH;const cell=current.cellText(pat,rowIndex,c)|| "... .. ... ...";const parts=colorParts(cell);patCtx.font=fontWeight+fontSize+"px monospace";patCtx.fillStyle=THEME.note;patCtx.fillText(parts.note,xBase+0,yMid);patCtx.fillStyle=THEME.inst;patCtx.fillText(parts.inst,xBase+28,yMid);patCtx.fillStyle=THEME.vol;patCtx.fillText(parts.vol,xBase+52,yMid);patCtx.fillStyle=THEME.fx;patCtx.fillText(parts.fx,xBase+88,yMid);}}}patCtx.strokeStyle="rgba(0,0,0,0.2)";patCtx.beginPath();patCtx.moveTo(0,cssH-0.5);patCtx.lineTo(cssW,cssH-0.5);patCtx.stroke();}file.addEventListener("change",async(e)=>{const f=e.target.files[0];if(!f)return;const buf=new Uint8Array(await f.arrayBuffer());if(current)current.destroy();current=new OpenMPTModule(buf);controls.classList.remove("hidden");document.getElementById("extras").classList.remove("hidden");specControls.classList.remove("hidden");const title=getMeta(current.mod,"title");const type=getMeta(current.mod,"type");const tracker=getMeta(current.mod,"tracker");const message=getMeta(current.mod,"message");const instruments=getMeta(current.mod,"instruments");const samples=getMeta(current.mod,"samples");let sizeStr;if(f.size>=1024*1024)sizeStr=(f.size/(1024*1024)).toFixed(2)+" MB";else sizeStr=(f.size/1024).toFixed(1)+" KB";metaBox.textContent=`File:${f.name}(${sizeStr})Title:${title}Type:${type}Tracker:${tracker}Instruments:${instruments}Samples:${samples}`;document.getElementById("songMessage").textContent=message || "(no message)";totalSubsongs=current.numSubsongs();showSubsongButtons(totalSubsongs>1);updateSubsongUI(current.getSubsong());seek.max=current.duration();durEl.textContent=fmtTime(current.duration());renderPattern();});function updateSubsongUI(idx){seek.max=current.duration();durEl.textContent=fmtTime(current.duration());renderPattern();btnPrevSubsong.disabled=idx<=0;btnNextSubsong.disabled=idx>=totalSubsongs-1;}btnPrevSubsong.addEventListener("click",()=>{if(!current)return;let idx=current.getSubsong();if(idx>0){idx--;current.setSubsong(idx);updateSubsongUI(idx);}});btnNextSubsong.addEventListener("click",()=>{if(!current)return;let idx=current.getSubsong();if(idx<totalSubsongs-1){idx++;current.setSubsong(idx);updateSubsongUI(idx);}});btnPlay.addEventListener("click",()=>{if(!current)return;ensureAudioGraph();playing=true;audioCtx.resume();});btnPause.addEventListener("click",()=>{playing=false;});btnStop.addEventListener("click",()=>{if(!current)return;playing=false;current.setPos(0);});seek.addEventListener("input",(e)=>{if(!current)return;current.setPos(parseFloat(e.target.value));});volEl.addEventListener("input",(e)=>{if(gainNode)gainNode.gain.value=parseFloat(e.target.value);});amigaFilter.addEventListener("change",(e)=>{setAmiga(e.target.checked);});barSizeEl.addEventListener("input",(e)=>{barGroupSize=parseInt(e.target.value)|| 4;});gravityEl.addEventListener("input",(e)=>{gravity=parseFloat(e.target.value)|| 0.6;});glowEl.addEventListener("input",(e)=>{glowBlur=parseInt(e.target.value)|| 10;});function updateUI(){requestAnimationFrame(updateUI);if(current){const pos=current.getPos();curEl.textContent=fmtTime(pos);seek.value=pos;renderPattern();}renderSpectrum();}let resizeRaf=0;function onResize(){if(resizeRaf)cancelAnimationFrame(resizeRaf);resizeRaf=requestAnimationFrame(()=>{renderSpectrum();renderPattern();});}window.addEventListener("resize",onResize,{passive:true});updateUI();};