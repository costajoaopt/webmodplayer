Module.onRuntimeInitialized=()=>{const e={sky1:"#e8eef7",sky2:"#d6deeb",blue1:"#3a64c9",blue2:"#0f245d",ink:"#2d3e55",sep:"#3a4a63",glow:"rgba(60,190,240,1)",grid:"rgba(30,40,60,0.35)",specBgTop:"#7a90a8",specBgBot:"#2e4a66",barTop:"#b3e5f9",barBot:"#1d6d96",peak:"#d0eaff",note:"#0d2c73",inst:"#1c6e1c",vol:"#a31212",fx:"#531875"},t=e=>Number.isFinite(e)?((e=Math.max(0,Math.floor(e)))/60|0)+":"+(e%60).toString().padStart(2,"0"):"0:00";function n(e,t){switch(t){case"instruments":return Module._openmpt_module_get_num_instruments(e);case"samples":return Module._openmpt_module_get_num_samples(e);default:const n=lengthBytesUTF8(t)+1,o=Module._malloc(n);stringToUTF8(t,o,n);const l=Module._openmpt_module_get_metadata(e,o);if(Module._free(o),!l)return"";const d=UTF8ToString(l);return Module._openmpt_free_string(l),d}}const o=document.getElementById("btnAbout"),l=document.getElementById("aboutModal"),d=document.getElementById("btnCloseModal"),r=document.getElementById("aboutText"),a=document.getElementById("file"),i=document.getElementById("controls"),s=document.getElementById("btnPlay"),u=document.getElementById("btnPause"),m=document.getElementById("btnStop"),c=document.getElementById("btnPrevSubsong"),g=document.getElementById("btnNextSubsong"),f=document.getElementById("seek"),p=document.getElementById("cur"),h=document.getElementById("dur"),_=document.getElementById("vol"),y=document.getElementById("spectrum"),b=y.getContext("2d"),S=document.getElementById("patternCanvas"),v=S.getContext("2d"),x=document.getElementById("barSize"),B=document.getElementById("gravity"),w=document.getElementById("glow"),E=document.getElementById("specControls"),M=document.getElementById("amigaFilter"),C=18,T=120,I=40,k=6;let L=null,A=null,P=null,F=null,R=null,G=!1,q=1;class U{constructor(e){if(this.buf=Module._malloc(e.length),HEAPU8.set(e,this.buf),this.mod=Module._openmpt_module_create_from_memory(this.buf,e.length,0,0,0),!this.mod)throw new Error("Could not create module")}destroy(){this.mod&&Module._openmpt_module_destroy(this.mod),this.buf&&Module._free(this.buf),this.mod=0,this.buf=0}duration(){return Module._openmpt_module_get_duration_seconds(this.mod)}getPos(){return Module._openmpt_module_get_position_seconds(this.mod)}setPos(e){Module._openmpt_module_set_position_seconds(this.mod,e)}numChannels(){return Module._openmpt_module_get_num_channels(this.mod)}readStereo(e,t){const n=2*t*4,o=Module._malloc(n),l=Module._openmpt_module_read_interleaved_float_stereo(this.mod,e,t,o),d=new Float32Array(HEAPF32.buffer,o,2*l).slice();return Module._free(o),d}cellText(e,t,n){const o=Module._openmpt_module_format_pattern_row_channel(this.mod,e,t,n,0,0);if(!o)return"";const l=UTF8ToString(o);return Module._openmpt_free_string(o),l}numSubsongs(){return Module._openmpt_module_get_num_subsongs(this.mod)}getSubsong(){return Module._openmpt_module_get_selected_subsong(this.mod)}setSubsong(e){Module._openmpt_module_select_subsong(this.mod,e)}}let W=[],z=[],H=8,N=.2,j=7;function D(t,n){const o=b.createLinearGradient(0,0,0,n);o.addColorStop(0,e.specBgTop),o.addColorStop(1,e.specBgBot),b.fillStyle=o,b.fillRect(0,0,t,n),b.strokeStyle=e.grid,b.lineWidth=1,b.beginPath();for(let e=0;e<=n;e+=10)b.moveTo(0,e+.5),b.lineTo(t,e+.5);for(let e=0;e<=t;e+=10)b.moveTo(e+.5,0),b.lineTo(e+.5,n);b.stroke();const l=b.createLinearGradient(0,0,0,.45*n);l.addColorStop(0,"rgba(255,255,255,0.55)"),l.addColorStop(1,"rgba(255,255,255,0)"),b.fillStyle=l,b.fillRect(0,0,t,.45*n)}function O(){const{w:t,h:n}=function(e,t,n){const o=e.getBoundingClientRect(),l=Math.max(10,o.width||e.clientWidth||e.width),d=n||o.height||e.clientHeight||e.height,r=window.devicePixelRatio||1;return e.width=Math.round(l*r),e.height=Math.round(d*r),e.style.width=l+"px",e.style.height=d+"px",t.setTransform(r,0,0,r,0,0),{w:l,h:d,dpr:r}}(y,b,80);if(!P)return void D(t,n);D(t,n);const o=new Uint8Array(P.frequencyBinCount);P.getByteFrequencyData(o);const l=Math.max(1,Math.floor(o.length/H)),d=t/l;W.length!==l&&(W=new Array(l).fill(0),z=new Array(l).fill(0));const r=b.createLinearGradient(0,0,0,n);r.addColorStop(0,e.barTop),r.addColorStop(1,e.barBot);for(let t=0;t<l;t++){let l=0;for(let e=0;e<H;e++)l+=o[t*H+e]||0;const a=l/(255*H)*n;j>0&&(b.save(),b.shadowBlur=j,b.shadowColor=e.glow,b.fillStyle=r,b.fillRect(t*d+1,n-a,d-2,a),b.restore()),b.fillStyle=r,b.fillRect(t*d+1,n-a,d-2,a),a>W[t]?(W[t]=a,z[t]=0):(z[t]+=N,W[t]-=z[t],W[t]<0&&(W[t]=0,z[t]=0));const i=n-W[t],s=Math.max(2,Math.min(4,.2*d));b.fillStyle=e.peak,b.fillRect(t*d+1,i-s,d-2,s),b.fillStyle="rgba(255,255,255,0.45)",b.fillRect(t*d+1,i-s,d-2,.5*s)}}function $(e){const t=(e||"... .. ... ...").padEnd(14," ");return{note:t.slice(0,3),inst:t.slice(4,6),vol:t.slice(7,10),fx:t.slice(11,14)}}function K(e,t,n,o,l,d){e.beginPath(),e.moveTo(t+d,n),e.lineTo(t+o-d,n),e.quadraticCurveTo(t+o,n,t+o,n+d),e.lineTo(t+o,n+l-d),e.quadraticCurveTo(t+o,n+l,t+o-d,n+l),e.lineTo(t+d,n+l),e.quadraticCurveTo(t,n+l,t,n+l-d),e.lineTo(t,n+d),e.quadraticCurveTo(t,n,t+d,n),e.closePath()}function X(){if(!R)return;const t=Module._openmpt_module_get_current_order(R.mod),n=Module._openmpt_module_get_order_pattern(R.mod,t),o=Module._openmpt_module_get_current_row(R.mod),l=Module._openmpt_module_get_pattern_num_rows(R.mod,n),d=R.numChannels(),r=Math.floor(1.5*C),a=I+k+d*T,i=Math.floor((512-r)/C),s=r+i*C,u=window.devicePixelRatio||1;S.width=Math.round(a*u),S.height=Math.round(s*u),S.style.width=a+"px",S.style.height=s+"px",v.setTransform(u,0,0,u,0,0);const m=v.createLinearGradient(0,0,0,s);m.addColorStop(0,e.sky1),m.addColorStop(1,e.sky2),v.fillStyle=m,v.fillRect(0,0,a,s);const c=v.createLinearGradient(0,0,0,r);c.addColorStop(0,e.blue1),c.addColorStop(1,e.blue2),v.fillStyle=c,v.fillRect(0,0,a,r);const g=v.createLinearGradient(0,0,0,.7*r);g.addColorStop(0,"rgba(255,255,255,0.55)"),g.addColorStop(1,"rgba(255,255,255,0)"),v.fillStyle=g,v.fillRect(0,0,a,.7*r),v.font="12px monospace",v.textBaseline="middle",v.textAlign="left",v.fillStyle="#fff",v.fillText("ROW",k,r/2),v.textAlign="center";for(let e=0;e<d;e++){const t=I+e*T+T/2;v.fillText("CHANNEL "+(e+1).toString().padStart(2,"0"),t,r/2)}v.textAlign="left",v.strokeStyle=e.sep,v.beginPath(),v.moveTo(0,r+.5),v.lineTo(a,r+.5),v.stroke(),v.strokeStyle="#8393ad",v.beginPath();for(let e=0;e<d;e++){const t=I+k+e*T-6+.5;v.moveTo(t,r),v.lineTo(t,s)}v.stroke();const f=Math.floor(i/2),p=r+f*C+C/2;v.textBaseline="middle";for(let t=-f;t<=f;t++){const r=o+t,i=r===o,s=p+t*C,u=s;if(r>=0&&r<l){const t=i?C+2:C;i?(v.save(),v.shadowColor="rgba(0,0,0,0.5)",v.shadowBlur=5,v.shadowOffsetY=2,v.fillStyle="#fff",K(v,.5,s-C/2+.5,a-1,t-1,3),v.fill(),v.restore(),v.strokeStyle=e.sep,v.lineWidth=1,K(v,.5,s-C/2+.5,a-1,t-1,3),v.stroke()):r%4==0&&(v.fillStyle="rgba(0,0,0,0.08)",v.fillRect(0,s-C/2,a,t));const o=i?14:12,l=i?"bold ":"";v.font=l+o+"px monospace",v.shadowColor="transparent",v.shadowBlur=0,v.fillStyle=i?"#0d2c73":"#000",v.fillText(r.toString().padStart(3,"0"),k,u);for(let t=0;t<d;t++){const d=I+k+t*T,a=$(R.cellText(n,r,t)||"... .. ... ...");v.font=l+o+"px monospace",v.fillStyle=e.note,v.fillText(a.note,d+0,u),v.fillStyle=e.inst,v.fillText(a.inst,d+28,u),v.fillStyle=e.vol,v.fillText(a.vol,d+52,u),v.fillStyle=e.fx,v.fillText(a.fx,d+88,u)}}}v.strokeStyle="rgba(0,0,0,0.2)",v.beginPath(),v.moveTo(0,s-.5),v.lineTo(a,s-.5),v.stroke()}function Y(e){f.max=R.duration(),h.textContent=t(R.duration()),X(),c.disabled=e<=0,g.disabled=e>=q-1}o.addEventListener("click",(()=>{l.classList.remove("hidden"),r.innerHTML=function(e){let t=e.replace(/\n/g,"<br/>");return t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t}("**ðŸŽµ Web Mod Player â€” AmigaOS 3 GlowIcons Edition**\n-----------------------------------------------\nA browser-based **MOD/XM/S3M/IT tracker music player** with a retro **Amiga GlowIcons-inspired** interface.\nMade as a fun side project to learn, experiment, and bring back a bit of 90s nostalgia âœ¨.\n\n**ðŸ’¡ Why?**\n-----------------------------------------------\nThis project was made **for learning, for fun, and out of nostalgia**.\nGrowing up with tracker music and Amiga-style UIs left a mark, and this is a little throwback project to recreate some of that magic in the browser.\nIt's not meant to be a full-featured player, just a simple demo to explore WebAudio and canvas graphics while paying homage to the classic Amiga aesthetic.\n\n-----------------------------------------------\n**August 28, 2025 â€” by CostaWorks**")})),d.addEventListener("click",(()=>{l.classList.add("hidden")})),a.addEventListener("change",(async e=>{const o=e.target.files[0];if(!o)return;const l=new Uint8Array(await o.arrayBuffer());R&&R.destroy(),R=new U(l),i.classList.remove("hidden"),document.getElementById("extras").classList.remove("hidden"),E.classList.remove("hidden");const d=n(R.mod,"title"),r=n(R.mod,"type"),a=n(R.mod,"tracker"),s=n(R.mod,"message"),u=n(R.mod,"instruments"),m=n(R.mod,"samples");let c;c=o.size>=1048576?(o.size/1048576).toFixed(2)+" MB":(o.size/1024).toFixed(1)+" KB",document.getElementById("meta-file").textContent=`${o.name} (${c})`,document.getElementById("meta-title").textContent=d,document.getElementById("meta-type").textContent=r,document.getElementById("meta-tracker").textContent=a,document.getElementById("meta-instruments").textContent=u,document.getElementById("meta-samples").textContent=m,document.getElementById("songMessage").textContent=s||"(no message)",q=R.numSubsongs(),function(e){const t=document.getElementById("btnPrevSubsong"),n=document.getElementById("btnNextSubsong");e?(t.classList.remove("hidden"),n.classList.remove("hidden")):(t.classList.add("hidden"),n.classList.add("hidden"))}(q>1),Y(R.getSubsong()),f.max=R.duration(),h.textContent=t(R.duration()),X()})),c.addEventListener("click",(()=>{if(!R)return;let e=R.getSubsong();e>0&&(e--,R.setSubsong(e),Y(e))})),g.addEventListener("click",(()=>{if(!R)return;let e=R.getSubsong();e<q-1&&(e++,R.setSubsong(e),Y(e))})),s.addEventListener("click",(()=>{R&&(L||(L=new(window.AudioContext||window.webkitAudioContext)),A||(A=L.createGain()),P||(P=L.createAnalyser(),P.fftSize=1024,P.smoothingTimeConstant=.75),F||(F=L.createScriptProcessor(4096,0,2),F.onaudioprocess=e=>{const t=e.outputBuffer.getChannelData(0),n=e.outputBuffer.getChannelData(1);if(!R||!G)return t.fill(0),void n.fill(0);const o=e.outputBuffer.length,l=R.readStereo(L.sampleRate,o);for(let e=0,d=0;e<o;e++,d+=2)t[e]=l[d]||0,n[e]=l[d+1]||0},F.connect(A)),A.connect(P),P.connect(L.destination),A.gain.value=parseFloat(_.value),G=!0,L.resume())})),u.addEventListener("click",(()=>{G=!1})),m.addEventListener("click",(()=>{R&&(G=!1,R.setPos(0))})),f.addEventListener("input",(e=>{R&&R.setPos(parseFloat(e.target.value))})),_.addEventListener("input",(e=>{A&&(A.gain.value=parseFloat(e.target.value))})),M.addEventListener("change",(e=>{var t;t=e.target.checked,R&&Module._openmpt_module_set_render_param(R.mod,3,t?0:1,0)})),x.addEventListener("input",(e=>{H=parseInt(e.target.value)||4})),B.addEventListener("input",(e=>{N=parseFloat(e.target.value)||.6})),w.addEventListener("input",(e=>{j=parseInt(e.target.value)||10}));let J=0;window.addEventListener("resize",(function(){J&&cancelAnimationFrame(J),J=requestAnimationFrame((()=>{O(),X()}))}),{passive:!0}),function e(){if(requestAnimationFrame(e),R){const e=R.getPos();p.textContent=t(e),f.value=e,X()}O()}()};